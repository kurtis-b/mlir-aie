rm -rf _build
mkdir -p _build
cd _build &&  cmake -E env CXXFLAGS="-std=c++23 -ggdb -DDTYPE_IN=std::bfloat16_t -DDTYPE_OUT=std::bfloat16_t -DDTYPE_ACC=float" \
	cmake `echo /home/cj/mlir-aie/programming_examples/basic/matrix_multiplication/npu2_single_core_bf16_test/..` -D CMAKE_C_COMPILER=gcc-13 -D CMAKE_CXX_COMPILER=g++-13 -DTARGET_NAME=single_core -Dsubdir=single_core
-- The C compiler identification is GNU 13.3.0
-- The CXX compiler identification is GNU 13.3.0
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - done
-- Check for working C compiler: /usr/bin/gcc-13 - skipped
-- Detecting C compile features
-- Detecting C compile features - done
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - done
-- Check for working CXX compiler: /usr/bin/g++-13 - skipped
-- Detecting CXX compile features
-- Detecting CXX compile features - done
-- Configuring done (0.3s)
-- Generating done (0.0s)
-- Build files have been written to: /home/cj/mlir-aie/programming_examples/basic/matrix_multiplication/npu2_single_core_bf16_test/_build
cd _build &&  cmake --build . --config Release
gmake[1]: Entering directory '/home/cj/mlir-aie/programming_examples/basic/matrix_multiplication/npu2_single_core_bf16_test/_build'
gmake[2]: Entering directory '/home/cj/mlir-aie/programming_examples/basic/matrix_multiplication/npu2_single_core_bf16_test/_build'
gmake[3]: Entering directory '/home/cj/mlir-aie/programming_examples/basic/matrix_multiplication/npu2_single_core_bf16_test/_build'
gmake[3]: Leaving directory '/home/cj/mlir-aie/programming_examples/basic/matrix_multiplication/npu2_single_core_bf16_test/_build'
gmake[3]: Entering directory '/home/cj/mlir-aie/programming_examples/basic/matrix_multiplication/npu2_single_core_bf16_test/_build'
[ 33%] Building CXX object CMakeFiles/single_core.dir/home/cj/mlir-aie/runtime_lib/test_lib/test_utils.cpp.o
[ 66%] Building CXX object CMakeFiles/single_core.dir/single_core/test.cpp.o
[100%] Linking CXX executable single_core
gmake[3]: Leaving directory '/home/cj/mlir-aie/programming_examples/basic/matrix_multiplication/npu2_single_core_bf16_test/_build'
[100%] Built target single_core
gmake[2]: Leaving directory '/home/cj/mlir-aie/programming_examples/basic/matrix_multiplication/npu2_single_core_bf16_test/_build'
gmake[1]: Leaving directory '/home/cj/mlir-aie/programming_examples/basic/matrix_multiplication/npu2_single_core_bf16_test/_build'
cp _build/single_core single_core.exe 
mkdir -p build
python3 /home/cj/mlir-aie/programming_examples/basic/matrix_multiplication/npu2_single_core_bf16_test/single_core.py -m 24 -k 16 -n 264 --b-col-maj 0 --dev npu2 -M 264 -K 768 -N 792 --dtype_in bf16 --dtype_out bf16 --emulate-bf16-mmul-with-bfp16 true --trace_size 0 > build/aie_264x768x792_24x16x264.mlir
mkdir -p build
cd build && /home/cj/mlir-aie/ironenv/lib/python3.12/site-packages/llvm-aie/bin/clang++ -O2 -std=c++20 --target=aie2p-none-unknown-elf -Wno-parentheses -Wno-attributes -Wno-macro-redefined -Wno-empty-body -Wno-missing-template-arg-list-after-template-kw -DNDEBUG -I /home/cj/mlir-aie/ironenv/lib/python3.12/site-packages/mlir_aie/include  -Dbf16_bf16_ONLY -DDIM_M=24 -DDIM_K=16 -DDIM_N=264 -I/home/cj/mlir-aie/programming_examples/basic/matrix_multiplication/npu2_single_core_bf16_test/../../../../aie_kernels/aie2p -DAIE_API_EMULATE_BFLOAT16_MMUL_WITH_BFP16 -c /home/cj/mlir-aie/programming_examples/basic/matrix_multiplication/npu2_single_core_bf16_test/mm_3x3.cc -o mm_24x16x264.o
mkdir -p build
cd build && aiecc.py --alloc-scheme=basic-sequential --aie-generate-xclbin --no-compile-host --xclbin-name=final_264x768x792_24x16x264.xclbin \
			--no-xchesscc --no-xbridge --peano /home/cj/mlir-aie/ironenv/lib/python3.12/site-packages/llvm-aie \
			--aie-generate-npu-insts --npu-insts-name=insts_264x768x792_24x16x264.txt ../build/aie_264x768x792_24x16x264.mlir

Generating: /home/cj/mlir-aie/programming_examples/basic/matrix_multiplication/npu2_single_core_bf16_test/build/aie_264x768x792_24x16x264.mlir.prj/aie_cdo_elfs.bin
Generating: /home/cj/mlir-aie/programming_examples/basic/matrix_multiplication/npu2_single_core_bf16_test/build/aie_264x768x792_24x16x264.mlir.prj/aie_cdo_init.bin
Generating: /home/cj/mlir-aie/programming_examples/basic/matrix_multiplication/npu2_single_core_bf16_test/build/aie_264x768x792_24x16x264.mlir.prj/aie_cdo_enable.bin
export XRT_HACK_UNSECURE_LOADING_XCLBIN=1 && \
 ./single_core.exe -x build/final_264x768x792_24x16x264.xclbin -i build/insts_264x768x792_24x16x264.txt -k MLIR_AIE -M 264 -K 768 -N 792 --b_col_maj 0 --warmup 10 --iters 1000 --verify 0

Avg NPU matmul time: 2675us.
Avg NPU gflops: 120.059

Min NPU matmul time: 2347us.
Max NPU gflops: 136.838

Max NPU matmul time: 3468us.
Min NPU gflops: 92.6065

PASS!

